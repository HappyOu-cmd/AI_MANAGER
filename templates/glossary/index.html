<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор глоссария - ИИ Менеджер</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .editor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .editor-actions {
            display: flex;
            gap: 12px;
        }
        .json-editor {
            width: 100%;
            min-height: 600px;
            font-family: var(--font-mono);
            font-size: 14px;
            padding: 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            background: var(--white);
            resize: vertical;
        }
        .json-editor:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px var(--primary-red-lighter);
        }
        .validation-errors {
            margin-top: 16px;
            padding: 16px;
            background: var(--error-lighter);
            border-left: 4px solid var(--error);
            border-radius: var(--border-radius);
            display: none;
        }
        .validation-errors.show {
            display: block;
        }
        .validation-errors h3 {
            color: var(--error);
            margin-bottom: 8px;
        }
        .validation-errors ul {
            margin: 0;
            padding-left: 20px;
        }
        .validation-errors li {
            margin: 4px 0;
            color: var(--text-dark);
        }
        .status-message {
            margin-top: 16px;
            padding: 12px;
            border-radius: var(--border-radius);
            display: none;
        }
        .status-message.success {
            background: var(--success-lighter);
            border-left: 4px solid var(--success);
            color: var(--text-dark);
            display: block;
        }
        .status-message.error {
            background: var(--error-lighter);
            border-left: 4px solid var(--error);
            color: var(--text-dark);
            display: block;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="editor-header">
            <div>
                <h1>Редактор глоссария</h1>
                <p style="color: var(--text-light); margin-top: 8px;">Редактирование JSON-глоссария для извлечения параметров из ТЗ</p>
            </div>
            <div class="editor-actions">
                <button class="btn btn-secondary" onclick="validateGlossary()">
                    <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                        <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor"/>
                    </svg>
                    Проверить
                </button>
                <button class="btn btn-primary" onclick="saveGlossary()">
                    <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                        <path d="M19 12V19H5V12H3V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V12H19ZM13 12.67L15.59 10.09L17 11.5L12 16.5L7 11.5L8.41 10.09L11 12.67V3H13V12.67Z" fill="currentColor"/>
                    </svg>
                    Сохранить
                </button>
            </div>
        </div>

        <div class="card">
            <textarea id="glossaryEditor" class="json-editor" placeholder="Загрузка глоссария..."></textarea>
            
            <div id="validationErrors" class="validation-errors">
                <h3>Ошибки валидации:</h3>
                <ul id="errorsList"></ul>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    <script>
        let glossaryData = null;

        // Загрузка глоссария при открытии страницы
        async function loadGlossary() {
            try {
                const response = await fetch('/glossary/api/get');
                const data = await response.json();
                
                if (data.success) {
                    glossaryData = data.glossary;
                    document.getElementById('glossaryEditor').value = JSON.stringify(glossaryData, null, 2);
                } else {
                    showError('Ошибка загрузки глоссария: ' + data.error);
                }
            } catch (error) {
                showError('Ошибка загрузки глоссария: ' + error.message);
            }
        }

        // Валидация глоссария
        async function validateGlossary() {
            const editor = document.getElementById('glossaryEditor');
            const errorsDiv = document.getElementById('validationErrors');
            const errorsList = document.getElementById('errorsList');
            
            try {
                const glossary = JSON.parse(editor.value);
                
                const response = await fetch('/glossary/api/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ glossary })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    errorsDiv.classList.remove('show');
                    if (typeof toast !== 'undefined') {
                        toast.success('Глоссарий валиден');
                    } else {
                        showStatus('Глоссарий валиден', 'success');
                    }
                } else {
                    errorsList.innerHTML = '';
                    data.errors.forEach(error => {
                        const li = document.createElement('li');
                        li.textContent = error;
                        errorsList.appendChild(li);
                    });
                    errorsDiv.classList.add('show');
                }
            } catch (error) {
                errorsList.innerHTML = '';
                const li = document.createElement('li');
                li.textContent = 'Ошибка парсинга JSON: ' + error.message;
                errorsList.appendChild(li);
                errorsDiv.classList.add('show');
            }
        }

        // Сохранение глоссария
        async function saveGlossary() {
            const editor = document.getElementById('glossaryEditor');
            const container = document.querySelector('.editor-container');
            
            try {
                const glossary = JSON.parse(editor.value);
                container.classList.add('loading');
                
                const response = await fetch('/glossary/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ glossary })
                });
                
                const data = await response.json();
                container.classList.remove('loading');
                
                if (data.success) {
                    if (typeof toast !== 'undefined') {
                        toast.success('Глоссарий успешно сохранен');
                    } else {
                        showStatus('Глоссарий успешно сохранен', 'success');
                    }
                    glossaryData = glossary;
                } else {
                    if (typeof toast !== 'undefined') {
                        toast.error('Ошибка сохранения: ' + data.error);
                    } else {
                        showStatus('Ошибка сохранения: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                container.classList.remove('loading');
                if (typeof toast !== 'undefined') {
                    toast.error('Ошибка парсинга JSON: ' + error.message);
                } else {
                    showStatus('Ошибка парсинга JSON: ' + error.message, 'error');
                }
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 5000);
        }

        function showError(message) {
            if (typeof toast !== 'undefined') {
                toast.error(message);
            } else {
                showStatus(message, 'error');
            }
        }

        // Загружаем глоссарий при загрузке страницы
        loadGlossary();
    </script>
</body>
</html>

